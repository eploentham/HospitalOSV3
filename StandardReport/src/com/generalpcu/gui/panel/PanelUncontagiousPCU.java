/*
 * PanelUncontagiousPCU.java
 *
 * Created on 23 กุมภาพันธ์ 2549, 14:28 น.
 */

package com.generalpcu.gui.panel;
import com.generalpcu.usecase.*;
import com.generalpcu.utility.Constant;
import com.generalpcu.utility.Report;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.JOptionPane;
import java.util.Vector;
import com.generalpcu.control.ManageControlSubject;
import com.generalpcu.utility.TableModelGUI;
import com.generalpcu.gui.panel.DialogShowStatus;
import com.generalpcu.utility.Language;
import com.generalpcu.utility.ComboboxModel;
import com.generalpcu.utility.ComboFix;
/**
 *
 * @author  pu
 */
public class PanelUncontagiousPCU extends javax.swing.JPanel implements
CardNameControl,GUIResp,Runnable,AllPanelResp
{
    ManageControlSubject theMCS;
    DialogShowStatus theDialogShowStatus;
    private String cardName;
    private String village;
    private String disease;
    private int selectedReport;
    private String startDate;
    private String endDate;
    private String[] headColumn ;
    private Vector vcDataQuery;
    TableModelGUI theTableModelGUI;
    DefaultTableCellRenderer rendererCenter;
    DefaultTableCellRenderer rendererRight;
    ComboboxModel theComboboxModel;
    Vector vcData;
    Vector vVillage;
    Vector vDisease;
    Thread theThread;
    private boolean isDbBackup;
    
    /** Creates new form PanelUncontagiousPCU */
    public PanelUncontagiousPCU(ManageControlSubject mcs)
    {
        theMCS = mcs;
        theMCS.theManageSubject.theGUISubject.registerGUIManage(this);
        theMCS.theManageSubject.theAllPanelSubject.registerAllPanelManage(this);
        initComponents();        
        cardName = ((Report)Constant.Report.get("3")).ENG_NAME;
        theDialogShowStatus = new DialogShowStatus(theMCS.theUS.getJFrame(),false,theMCS);
        theComboboxModel = new ComboboxModel();
        setLanguage();
        initReport();
        initComboBoxVillage();
        initComboBoxDisease();
    }
    
    /**
     *กำหนดการเลือกรายงานตอนเริ่มต้นการทำงาน โดยเลือกไว้ที่ รายชื่อผู้ป่วยโรคไม่ติดต่อ
     *@Author pu
     *@Date 23/02/2006
     */
    private void initReport()
    {
        if(jRadioButtonPerson.isSelected())
        {
            this.selectedReport = 1;
        }
        else
        {
            this.selectedReport = 2;
        }
        
    }
    /**
     *เซ็ตค่าให้กับ ComboBox หมู่บ้าน
     *@Author pu
     *@Date 23/02/2006
     */
    private void initComboBoxVillage()
    {
        vVillage = new Vector();            
        vVillage = theMCS.theManageControl.theComboBoxControl.listVillage(); 
        theComboboxModel.initComboBox(this.jComboBoxVillage, vVillage);
        theComboboxModel.setCodeComboBox(this.jComboBoxVillage, "0");
    }
    /**
     *เซ็ตค่าให้กับ ComboBox โรคไม่ติดต่อ
     *@Author pu
     *@Date 23/02/2006
     */
    private void initComboBoxDisease()
    {
        vDisease = new Vector();        
        vDisease = theMCS.theManageControl.theComboBoxControl.listDisease();
        theComboboxModel.initComboBox(this.jComboBoxDisease, vDisease);
        theComboboxModel.setCodeComboBox(this.jComboBoxDisease, "0");
    }
    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc=" Generated Code ">//GEN-BEGIN:initComponents
    private void initComponents()
    {
        java.awt.GridBagConstraints gridBagConstraints;

        buttonGroup1 = new javax.swing.ButtonGroup();
        jPanel1 = new javax.swing.JPanel();
        jLabel3 = new javax.swing.JLabel();
        jRadioButtonPerson = new javax.swing.JRadioButton();
        jRadioButtonDisease = new javax.swing.JRadioButton();
        jPanel3 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jComboBoxVillage = new javax.swing.JComboBox();
        jLabel2 = new javax.swing.JLabel();
        jComboBoxDisease = new javax.swing.JComboBox();
        jPanel2 = new javax.swing.JPanel();
        fixedColumnScrollPane1 = new com.hospital_os.utility.FixedColumnScrollPane();
        jTableUncontagious = new javax.swing.JTable();

        setLayout(new java.awt.GridBagLayout());

        jPanel1.setLayout(new java.awt.GridBagLayout());

        jLabel3.setFont(new java.awt.Font("Dialog", 1, 12));
        jLabel3.setText("SelectReportForQuery");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(0, 3, 0, 0);
        jPanel1.add(jLabel3, gridBagConstraints);

        buttonGroup1.add(jRadioButtonPerson);
        jRadioButtonPerson.setSelected(true);
        jRadioButtonPerson.setText("AmountPerson");
        jRadioButtonPerson.addActionListener(new java.awt.event.ActionListener()
        {
            public void actionPerformed(java.awt.event.ActionEvent evt)
            {
                jRadioButtonPersonActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.insets = new java.awt.Insets(0, 3, 0, 0);
        jPanel1.add(jRadioButtonPerson, gridBagConstraints);

        buttonGroup1.add(jRadioButtonDisease);
        jRadioButtonDisease.setText("PersonName");
        jRadioButtonDisease.addActionListener(new java.awt.event.ActionListener()
        {
            public void actionPerformed(java.awt.event.ActionEvent evt)
            {
                jRadioButtonDiseaseActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(0, 3, 0, 0);
        jPanel1.add(jRadioButtonDisease, gridBagConstraints);

        jPanel3.setLayout(new java.awt.GridBagLayout());

        jLabel1.setText("Village");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(0, 5, 0, 0);
        jPanel3.add(jLabel1, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.insets = new java.awt.Insets(0, 3, 0, 0);
        jPanel3.add(jComboBoxVillage, gridBagConstraints);

        jLabel2.setText("Disease");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(0, 5, 0, 0);
        jPanel3.add(jLabel2, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(0, 3, 0, 0);
        jPanel3.add(jComboBoxDisease, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.gridwidth = 3;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.insets = new java.awt.Insets(5, 0, 0, 0);
        jPanel1.add(jPanel3, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        add(jPanel1, gridBagConstraints);

        jPanel2.setLayout(new java.awt.GridBagLayout());

        jTableUncontagious.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][]
            {

            },
            new String []
            {

            }
        ));
        jTableUncontagious.setAutoResizeMode(javax.swing.JTable.AUTO_RESIZE_OFF);
        fixedColumnScrollPane1.setViewportView(jTableUncontagious);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        jPanel2.add(fixedColumnScrollPane1, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(5, 0, 0, 0);
        add(jPanel2, gridBagConstraints);

    }
    // </editor-fold>//GEN-END:initComponents

    private void jRadioButtonDiseaseActionPerformed(java.awt.event.ActionEvent evt)//GEN-FIRST:event_jRadioButtonDiseaseActionPerformed
    {//GEN-HEADEREND:event_jRadioButtonDiseaseActionPerformed
        if(jRadioButtonDisease.isSelected())
        {
            queryPatientName();
        }
    }//GEN-LAST:event_jRadioButtonDiseaseActionPerformed

    private void jRadioButtonPersonActionPerformed(java.awt.event.ActionEvent evt)//GEN-FIRST:event_jRadioButtonPersonActionPerformed
    {//GEN-HEADEREND:event_jRadioButtonPersonActionPerformed
        if(jRadioButtonPerson.isSelected())
        {
            queryPatientAmount();
        }
    }//GEN-LAST:event_jRadioButtonPersonActionPerformed
    /**
     *ให้ค่าที่ได้จากการดึงข้อมูล
     *@return Vector ของข้อมูลที่ได้จากการดึงรายงาน
     *@Author pu
     *@Date 23/02/2006
     */
    public Vector getUncontagiousPCU()
    {
        return this.vcData;
    }
    
    /**
     *ให้ชื่อของรายงานตามที่ได้เลือกจากหน้า GUI
     *@return String ที่เป็นชื่อของรายงาน ตามประเภทของรายงาน
     *@Author pu
     *@Date 23/02/2006
     */
    public String getNameReport()
    {
        if(this.selectedReport == 1)
            return "_PatientAmount";
        else if(this.selectedReport == 2)
            return "_PatientName";
        else
            return "";
    }
   /**
    *  ใช้ในการรับข้อมูลจาก การค้นหา และส่งค่าเข้ามา panel นี้
    *  เพื่อให้ทำการ Query และค้นหารายการตามข้อกำหนดของ panel
    *  @param startDate เป็น String เป็นวันที่เริ่มต้น อยู่ในรูปแบบ yyyy-mm-dd
    *  @param endDate เป็น String เป็นวันที่สิ้นสุด อยู่ในรูปแบบ yyyy-mm-dd
    **/
    public void setQueryReport(String startDate, String endDate, boolean dbBackup)
    {
        this.startDate = startDate;
        this.endDate = endDate;
        isDbBackup = dbBackup;
        startQuery();
    }
    private void startQuery()
    {
        theThread = new Thread(this);
        theThread.start();
    }
    /**
     *ดึงรายงานจำนวนผู้ป่วยโรคไม่ติดต่อ แยกตามหมู่บ้าน
     *@Author pu
     *@Date 23/02/2006
     */
    private void queryPatientAmount()
    {
        this.selectedReport = 1;
    }
    
    /**
     *ดึงรายงานรายชื่อผู้ป่วยที่เป็นโรคไม่ติดต่อ แยกตามหมู่บ้าน
     *@Author pu
     *@Date 23/02/2006
     */
    private void queryPatientName()
    {
        this.selectedReport = 2;
    }
    
    /**ใช้ในการ Clear ข้อมูลที่อยู่บนตาราง*/
    private void clearDataGUI()
    {
        vcData = null;
        showDataInTable(null,null);
        System.out.println("Clear Data in GUI");
    }
    
    public String getCardName()
    {
        return this.cardName;
    }
    
    public void notifySetInitAllGUI()
    {
        clearDataGUI();
    }
    
    public void notifyStopProcess()
    {
        try
        {
            if(theThread != null)
            {
                theThread.stop();
            }
            theThread = null;
            System.out.println("In stop in PanelUncontagiousPCU");
        }
        catch(Exception ex)
        {
            ex.printStackTrace();
        }
    }
    
    public void run()
    {
        this.disease = this.theComboboxModel.getCodeComboBox(jComboBoxDisease);
        this.village = this.theComboboxModel.getCodeComboBox(jComboBoxVillage);
        if(this.selectedReport == 1)
        {
            queryPatientAmountByDate();
        }
        else
        {
            queryPatienNametByDate();
        }
    }
    /**
     *ค้นหาข้อมูลรายงานจำนวนผู้ป่วยโรคไม่ติดต่อ ตามวันที่เริ่มต้น และสิ้นสุด
     *@Author pu
     *@Date 23/02/2006
     */
    private void queryPatientAmountByDate()
    {
        if(this.theMCS.theManageControl.theGeneralPCUControl.setDateForQuery(this.startDate, this.endDate ))
        {
            theDialogShowStatus.setVisible(true);
            theDialogShowStatus.showDialog(Language.getTextBundle("PleaseWait"),false);
            
            this.vcData = this.theMCS.theManageControl.theGeneralPCUControl.queryUncontagiousPatientAmount(this.village
                    , this.disease
                    , isDbBackup);
            headColumn = new String[] {""};
            vcDataQuery = null;
            if(vcData != null)
            {                
                headColumn = (String[])vcData.get(0);
                vcDataQuery = (Vector)vcData.get(1);
            }
            
            showDataInTable(headColumn, vcDataQuery);
            theDialogShowStatus.setVisible(false);
        }
        else
            showMessageStartYearOver();
    }
    
    /**
     *ค้นหาข้อมูลรายงานจำนวนผู้ป่วยโรคไม่ติดต่อ ตามวันที่เริ่มต้น และสิ้นสุด
     *@Author pu
     *@Date 23/02/2006
     */
    private void queryPatienNametByDate()
    {
        if(this.theMCS.theManageControl.theGeneralPCUControl.setDateForQuery(this.startDate, this.endDate))
        {
            theDialogShowStatus.setVisible(true);
            theDialogShowStatus.showDialog(Language.getTextBundle("PleaseWait"),false);
            this.vcData = this.theMCS.theManageControl.theGeneralPCUControl.queryUncontagiousPatientName(this.village
                    , this.disease
                    ,isDbBackup);
            headColumn = new String[] {""};
            vcDataQuery = null;
            if(vcData != null)
            {                
                headColumn = (String[])vcData.get(0);
                vcDataQuery = (Vector)vcData.get(1);
            }
            
            showDataInTable(headColumn, vcDataQuery);
            theDialogShowStatus.setVisible(false);
        }
        
        else
            showMessageStartYearOver();
    }
    /**แสดงข้อความ วันที่เริ่ม และวันที่สิ้นสุด ต้อง มีปี เดียวกัน*/
    private void showMessageStartYearOver()
    {
        JOptionPane.showMessageDialog(this, Language.getTextBundle("StartYearNotSameEndYear"),Language.getTextBundle("Warning"),JOptionPane.OK_OPTION);
    }
    private void showDataInTable(String[] columnname,Vector vc)
    {
        String[] col = columnname;
        
        int size = 0;
        if(vc != null)
        {   theTableModelGUI= new TableModelGUI(col,vc.size());
            size = vc.size();
            //วนลูป ต่อ 1 แถว
            for(int i=0 ;i<size; i++)
            {    //วนลูปของ column
                String[] rowdata = (String[])vc.get(i);
                
                for(int j = 0 ; j < rowdata.length ;j++)
                {
                    theTableModelGUI.setValueAt(rowdata[j],i,j);
                }
                theTableModelGUI.setEditingCol(rowdata.length+1);
                rowdata = null;
            }
        }
        else
        {   theTableModelGUI= new TableModelGUI(col,0);
        }
        this.jTableUncontagious.setModel(theTableModelGUI);
        //pu : Fix column แรกของ GUI ให้อยู่กับที่
        if(col!= null && col.length!= 0)
        {
            fixedColumnScrollPane1.setFixedColumnScrollPane(jTableUncontagious, 1, 80);
            //fixedColumnScrollPane1.setFixedColumnScrollPane(jTableUncontagious, 2, 150);
            setTableListReportPattern(col);
        }
        else
        {
            fixedColumnScrollPane1.setFixedColumnScrollPane(jTableUncontagious, 0, 50);
            setTableListReportPattern(new String[0]);
        }
        sendDataToMainReport(size);
    }
    /**ใช้ในการแสดงความกว้างของคอลัมน์
     *@param col เป็น Array ของ String ที่เก็บหัว column สำหรับนำมานับจำนวน Column ที่ต้องสร้างในตาราง
     *
     */
    private void setTableListReportPattern(String [] col)
    {
        if(rendererCenter == null )
        {
            rendererCenter = new DefaultTableCellRenderer();
        }
        if(rendererRight == null)
        {
            rendererRight = new DefaultTableCellRenderer();
        }
        rendererCenter.setHorizontalAlignment(javax.swing.JLabel.CENTER);
        rendererRight.setHorizontalAlignment(javax.swing.JLabel.RIGHT);
        
        String[] col_number = col;
        int size = col_number.length;
        for(int i=0;i<size-1;i++)
        {
            if(this.selectedReport == 1)
            {
                if(i == 0)
                {
                    //ojika 22 jan 2007
                    jTableUncontagious.getColumnModel().getColumn(i).setCellRenderer(rendererRight);
                    jTableUncontagious.getColumnModel().getColumn(i).setPreferredWidth(150);
                }
                else if(i==1)
                {                   
                    jTableUncontagious.getColumnModel().getColumn(i).setPreferredWidth(150);
                }
                else
                {
                    jTableUncontagious.getColumnModel().getColumn(i).setCellRenderer(rendererRight);
                    jTableUncontagious.getColumnModel().getColumn(i).setPreferredWidth(100);
                }
            }
            else
            {
                if(i == 0)
                {
                    //ojika 22 jan 2007
                    jTableUncontagious.getColumnModel().getColumn(i).setCellRenderer(rendererRight);
                    jTableUncontagious.getColumnModel().getColumn(i).setPreferredWidth(150);
                }
                else if(i == 1)
                {
                    jTableUncontagious.getColumnModel().getColumn(i).setPreferredWidth(60);
                }
                else if(i == 2 || i==3)
                {
                    jTableUncontagious.getColumnModel().getColumn(i).setCellRenderer(rendererRight);
                    jTableUncontagious.getColumnModel().getColumn(i).setPreferredWidth(100);
                }
                else if(i == 4 || i==5 || i==6 || i==7)
                {                 
                    jTableUncontagious.getColumnModel().getColumn(i).setCellRenderer(rendererRight);
                    jTableUncontagious.getColumnModel().getColumn(i).setPreferredWidth(80);
                }
                else
                {
                    jTableUncontagious.getColumnModel().getColumn(i).setPreferredWidth(130);
                }
            }
        }
    }
    /**
     *  ใช้ในการส่งสถานะให้แสดง ปุ่มบันทึกหรือไม่ โดยจะตรวจสอบจาก size ของตาราง
     */
    private void sendDataToMainReport(int size)
    {
        theMCS.theManageSubject.theMainReportSubject.notifyShowSaveToFile(false);
        if(size >0)
        {
            theMCS.theManageSubject.theMainReportSubject.notifyShowSaveToFile(true);
        }
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup buttonGroup1;
    private com.hospital_os.utility.FixedColumnScrollPane fixedColumnScrollPane1;
    private javax.swing.JComboBox jComboBoxDisease;
    private javax.swing.JComboBox jComboBoxVillage;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JRadioButton jRadioButtonDisease;
    private javax.swing.JRadioButton jRadioButtonPerson;
    private javax.swing.JTable jTableUncontagious;
    // End of variables declaration//GEN-END:variables
    public void setLanguage()
    {
        jRadioButtonPerson.setText(Language.getTextBundle(jRadioButtonPerson.getText()));
        jRadioButtonDisease.setText(Language.getTextBundle(jRadioButtonDisease.getText()));
        jLabel1.setText(Language.getTextBundle(jLabel1.getText()));
        jLabel2.setText(Language.getTextBundle(jLabel2.getText()));
        jLabel3.setText(Language.getTextBundle(jLabel3.getText()));
    }
}
