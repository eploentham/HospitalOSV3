/*
 * PanelOrderLab.java
 *
 * Created on 1 พฤศจิกายน 2548, 13:56 น.
 */

package com.generalreport.gui.panel.report;

import com.generalreport.gui_component.TableModelGUI;
import com.generalreport.subject.ManageAllPanel;
import com.generalreport.subject.ManageGUI;
import com.generalreport.utility.Constant;
import com.generalreport.utility.Language;
import com.generalreport.utility.Report;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.JOptionPane;
import java.util.Vector;

import com.generalreport.utility.GUIControl;
import com.generalreport.control.HosManage;
import com.generalreport.gui_component.DialogShowStatus;

/**
 *
 * @author  nu_ojika
 */
public class PanelOrderLab extends javax.swing.JPanel implements 
GUIControl,ManageGUI,Runnable,ManageAllPanel{
    
    /** Creates new form PanelOrderLab */
    HosManage theHosManage;
    Thread theThread;
    private String startDate;
    private String endDate;    
    final private String cardName;
    private DefaultTableCellRenderer rendererCenter;
    
    Vector vcData;
    String[] headColumn;
    Vector vcDataQuery;
    TableModelGUI theTableModelGUI;
    DialogShowStatus theDialogShowStatus;
    int language = 1;
    private String sub_fileName = "OrderLabIn";
    private boolean isDbBackup;
    
    public PanelOrderLab(HosManage hosManage) {
        theHosManage = hosManage;
        theHosManage.theHosControl.theHosSubject.theGUISubject.registerGUIManage(this);
        theHosManage.theHosControl.theHosSubject.theAllPanelSubject.registerAllPanelManage(this);
        
        cardName = ((Report)Constant.Report.get("16")).ENG_NAME;
        initComponents();
        setLanguage();
        setEnableOrderLabReport(false);
        
        theDialogShowStatus = new DialogShowStatus(theHosManage.theUS.getJFrame(),false,theHosManage);
    }

    public void notifySetInitAllGUI() {
        clearDataGUI();
    }
    
     /**ใช้ในการ Clear ข้อมูลที่อยู่บนตาราง*/
    private void clearDataGUI()
    {
        showDataInTable(new String[] {""}, null);
        System.out.println("Clear Data in GUI");
    }

    /**run thread*/
    public void run()
    {
       setEnableOrderLabReport(true);
       this.jRadioButtonLabInHospital.setSelected(true);
       queryOrderLabInHospitalByDate();    
    }    
    /**
     *  ส่งชื่อของ panel ไปให้ Frame หลังที่จะใช้ในการทำ card Layout
     *  @return string เป็น ชื่อ ของ panel เป็นอังกฤษ
     */ 
    public String getCardName()
    {
        return cardName;
    }       
    
    /**แสดงข้อความ วันที่เริ่ม และวันที่สิ้นสุด ต้อง มีปี เดียวกัน*/
    private void showMessageStartYearOver()
    {
        JOptionPane.showMessageDialog(this, Language.getTextBundle("StartYearNotSameEndYear", language),"Warnning",JOptionPane.OK_OPTION);
        
    }
    
     /**
     *  ใช้ในการรับ notify เมื่อมีการ stop service 
     */
    public void notifyStopProcess()
    {
         try
        {
              if(theThread != null)
              {
                  theThread.stop();
              }
              theThread = null;
              System.out.println("In stop in PanelReportARIC");
        }
        catch(Exception ex)
        {
            ex.printStackTrace();
        }        
    }

    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc=" Generated Code ">//GEN-BEGIN:initComponents
    private void initComponents() {
        java.awt.GridBagConstraints gridBagConstraints;

        buttonGroup1 = new javax.swing.ButtonGroup();
        jPanel1 = new javax.swing.JPanel();
        jPanel2 = new javax.swing.JPanel();
        jRadioButtonLabInHospital = new javax.swing.JRadioButton();
        jRadioButtonLabReferOut = new javax.swing.JRadioButton();
        jRadioButtonLabReferIn = new javax.swing.JRadioButton();
        jLabel5 = new javax.swing.JLabel();
        jPanel3 = new javax.swing.JPanel();
        jScrollPane3 = new javax.swing.JScrollPane();
        jTableOrderLabReport = new javax.swing.JTable();

        setLayout(new java.awt.BorderLayout());

        jPanel1.setLayout(new java.awt.GridBagLayout());

        jPanel1.setBorder(new javax.swing.border.EtchedBorder());
        jPanel2.setLayout(new java.awt.GridBagLayout());

        buttonGroup1.add(jRadioButtonLabInHospital);
        jRadioButtonLabInHospital.setText("LabInHospital");
        jRadioButtonLabInHospital.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jRadioButtonLabInHospitalActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.insets = new java.awt.Insets(0, 3, 0, 0);
        jPanel2.add(jRadioButtonLabInHospital, gridBagConstraints);

        buttonGroup1.add(jRadioButtonLabReferOut);
        jRadioButtonLabReferOut.setText("LabReferOut");
        jRadioButtonLabReferOut.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jRadioButtonLabReferOutActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 2;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.insets = new java.awt.Insets(0, 3, 0, 0);
        jPanel2.add(jRadioButtonLabReferOut, gridBagConstraints);

        buttonGroup1.add(jRadioButtonLabReferIn);
        jRadioButtonLabReferIn.setText("LabReferIn");
        jRadioButtonLabReferIn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jRadioButtonLabReferInActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 3;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(0, 3, 0, 0);
        jPanel2.add(jRadioButtonLabReferIn, gridBagConstraints);

        jLabel5.setText("SelectLabReport");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.VERTICAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        jPanel2.add(jLabel5, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(3, 3, 0, 3);
        jPanel1.add(jPanel2, gridBagConstraints);

        jPanel3.setLayout(new java.awt.GridBagLayout());

        jTableOrderLabReport.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {

            }
        ));
        jScrollPane3.setViewportView(jTableOrderLabReport);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(3, 3, 3, 3);
        jPanel3.add(jScrollPane3, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(5, 3, 0, 3);
        jPanel1.add(jPanel3, gridBagConstraints);

        add(jPanel1, java.awt.BorderLayout.CENTER);

    }
    // </editor-fold>//GEN-END:initComponents

    private void jRadioButtonLabReferInActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jRadioButtonLabReferInActionPerformed
        this.sub_fileName = "OrderLabReferIn";
        queryOrderLabReferInByDate();
    }//GEN-LAST:event_jRadioButtonLabReferInActionPerformed

    private void jRadioButtonLabReferOutActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jRadioButtonLabReferOutActionPerformed
        this.sub_fileName = "OrderLabReferOut";
        queryOrderLabReferOutByDate();
    }//GEN-LAST:event_jRadioButtonLabReferOutActionPerformed

    private void jRadioButtonLabInHospitalActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jRadioButtonLabInHospitalActionPerformed
        this.sub_fileName = "OrderLabIn";
        queryOrderLabInHospitalByDate();
       // showCurrentDate();
    }//GEN-LAST:event_jRadioButtonLabInHospitalActionPerformed
    /**
     *  ใช้ในการดึงข้อมูลรายการLAB ที่ตรตวจภายในโรงพยาบาล
     **/
    private void queryOrderLabInHospitalByDate()
    {
        if(theHosManage.theHosControl.theRPOrderLabControl.setDateForQuery(this.startDate,this.endDate))
        {
            theDialogShowStatus.setVisible(false);
            theDialogShowStatus.showDialog("กรุณารอสักครู่",false);

            vcData = theHosManage.theHosControl.theRPOrderLabControl.queryOrderLabInHospitalByDate(isDbBackup);
            headColumn = new String[] {""};
            vcDataQuery = null;
            if(vcData != null)
            {

                headColumn = (String[])vcData.get(0);
                vcDataQuery = (Vector)vcData.get(1);
            }

            showDataInTable(headColumn, vcDataQuery);
            theDialogShowStatus.setVisible(false);       
        }
        else
        {
            showMessageStartYearOver();
        }
    }
    
    /**
     *  ใช้ในการดึงข้อมูลรายการLAB ที่ตรตวจภายในโรงพยาบาล
     **/
    private void queryOrderLabReferOutByDate()
    {
        if(theHosManage.theHosControl.theRPOrderLabControl.setDateForQuery(this.startDate,this.endDate))
        {
            theDialogShowStatus.setVisible(false);
            theDialogShowStatus.showDialog("กรุณารอสักครู่",false);

            vcData = theHosManage.theHosControl.theRPOrderLabControl.queryOrderLabReferOutByDate();
            headColumn = new String[] {""};
            vcDataQuery = null;
            if(vcData != null)
            {

                headColumn = (String[])vcData.get(0);
                vcDataQuery = (Vector)vcData.get(1);
            }

            showDataInTable(headColumn, vcDataQuery);
            theDialogShowStatus.setVisible(false);       
        }
        else
        {
            showMessageStartYearOver();
        }
    }
    
    /**
     *  ใช้ในการดึงข้อมูลรายการLAB ที่ตรตวจภายในโรงพยาบาล
     **/
    private void queryOrderLabReferInByDate()
    {
        if(theHosManage.theHosControl.theRPOrderLabControl.setDateForQuery(this.startDate,this.endDate))
        {
            theDialogShowStatus.setVisible(false);
            theDialogShowStatus.showDialog("กรุณารอสักครู่",false);

            vcData = theHosManage.theHosControl.theRPOrderLabControl.queryOrderLabReferInByDate();
            headColumn = new String[] {""};
            vcDataQuery = null;
            if(vcData != null)
            {

                headColumn = (String[])vcData.get(0);
                vcDataQuery = (Vector)vcData.get(1);
            }

            showDataInTable(headColumn, vcDataQuery);
            theDialogShowStatus.setVisible(false);       
        }
        else
        {
            showMessageStartYearOver();
        }
    }
    
    /**ใช้ในการรับข้อมูลจาก การค้นหา และส่งค่าเข้ามา panel นี้
     *  เพื่อให้ทำการ Query และค้นหารายการตามข้อกำหนดของ panel
     *  @param startDate เป็น String เป็นวันที่เริ่มต้น อยู่ในรูปแบบ yyyy-mm-dd
     *  @param endDate เป็น String เป็นวันที่สิ้นสุด อยู่ในรูปแบบ yyyy-mm-dd
     */
    public void setQueryReport(String startDate, String endDate, boolean dbBackup)
    {
        this.startDate = startDate;
        this.endDate = endDate;
        isDbBackup = dbBackup;
        //setFileDescription();
        startQuery();
        // queryDataByDate(startDate,endDate);
    }
    
    /**
     *  ใช้ในการเริ่มให้ thread เริ่มทำงาน จะต้องมาเรียก method นี้ทุกครั้ง
     * 
     */
    private void startQuery()
    {
        theThread = new Thread(this);
        theThread.start();
    }
    /**
     *  ส่งค่าข้อมูลกลับไปยัง Frame หลักเมื่อมีการบันทึกออกมาเป็นไฟล์
     *  @return Vector ของ ข้อมูลที่ Query ออกมาได้
     */
    public Vector getData()
    {
        return this.vcData;
    }
    
     private void showDataInTable(String[] columnname,Vector vc)
    {
             
        String[] col = columnname;      
        
        int size = 0;
        if(vc != null)
        {   theTableModelGUI= new TableModelGUI(col,vc.size());
            size = vc.size();
            
            //วนลูป ต่อ 1 แถว
            for(int i=0 ;i<size; i++)
            {    //วนลูปตของ column
                String[] rowdata = (String[])vc.get(i);

                for(int j = 0 ; j < rowdata.length ;j++)
                {
                    
                    theTableModelGUI.setValueAt(rowdata[j],i,j);                        
                }
                theTableModelGUI.setEditingCol(rowdata.length+1);
                rowdata = null;
                
                //    tm.setValueAt(((OrderItem)this.theOrderControl.listOrderItemByItem(p.getObjectId(),this.vn)).refer_out,i,2);
            }                
                       
        }
        else
        {   theTableModelGUI= new TableModelGUI(col,0);            
        }
        this.jTableOrderLabReport.setModel(theTableModelGUI);
        if(col!= null && col.length!= 0)
        {
            setTableListReportPattern(col);
        }
        sendDataToMainReport(size);
    }
    
    /**ใช้ในการแสดงความกว้างของคอลัมน์
     *@param col เป็น Array ของ String ที่เก็บหัว column สำหรับนำมานับจำนวน Column ที่ต้องสร้างในตาราง
     *
     */
    private void setTableListReportPattern(String [] col)
    {
        if(rendererCenter == null )
        {
            rendererCenter = new DefaultTableCellRenderer();
        }
        rendererCenter.setHorizontalAlignment(javax.swing.JLabel.CENTER);
        
        String[] col_number = col;
        int size = col_number.length;
        for(int i=0;i<size;i++)
        {
            if(i == (size-1))
            {
                jTableOrderLabReport.getColumnModel().getColumn(i).setCellRenderer(rendererCenter);
                jTableOrderLabReport.getColumnModel().getColumn(i).setPreferredWidth(10);                
            }
            else
            {
                jTableOrderLabReport.getColumnModel().getColumn(i).setPreferredWidth(70);
            }

        }
    }
    
    /**
     *  ใช้ในการส่งสถานะให้แสดง ปุ่มบันทึกหรือไม่ โดยจะตรวจสอบจาก size ของตาราง
     */
    private void sendDataToMainReport(int size)
    {
        theHosManage.theHosControl.theHosSubject.theMainReportSubject.notifyShowSaveToFile(false);
        if(size >0)
        {
            theHosManage.theHosControl.theHosSubject.theMainReportSubject.notifyShowSaveToFile(true);
        }
    }
    
    private void setEnableOrderLabReport(boolean flag)
    {
        this.jRadioButtonLabInHospital.setEnabled(flag);
        this.jRadioButtonLabReferOut.setEnabled(flag);
        this.jRadioButtonLabReferIn.setEnabled(flag);
    }
    
    private void setLanguage()
    {
        jLabel5.setText(Language.getTextBundle(jLabel5.getText(),1));     
        
        jRadioButtonLabInHospital.setText(Language.getTextBundle(jRadioButtonLabInHospital.getText(),1));
        jRadioButtonLabReferOut.setText(Language.getTextBundle(jRadioButtonLabReferOut.getText(),1));
        jRadioButtonLabReferIn.setText(Language.getTextBundle(jRadioButtonLabReferIn.getText(),1));
    }
    
     /**
     *ส่งชื่อของไฟล์ เพื่อนำไปต่อเป็นชื่อไฟล์ที่ได้เซ้ตไว้แล้ว 
     * เพื่อระบุให้ชัดเจนว่ารายงานที่ถูก save เป็นรายงานอะไร
     *@return String เป็นชื่อไฟลืที่ต้องการนำไปต่อ
     */
    public String getFileName()
    {
        return sub_fileName;
    }
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JRadioButton jRadioButtonLabInHospital;
    private javax.swing.JRadioButton jRadioButtonLabReferIn;
    private javax.swing.JRadioButton jRadioButtonLabReferOut;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JTable jTableOrderLabReport;
    // End of variables declaration//GEN-END:variables
    
}
