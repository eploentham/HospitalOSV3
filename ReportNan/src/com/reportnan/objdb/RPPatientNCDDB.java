/*
 * RPPatientNCDDB.java
 *
 * Created on 19 มิถุนายน 2549 , 11:56 น.
 *
 * To change this template, choose Tools | Options and locate the template under
 * the Source Creation and Management node. Right-click the template and choose
 * Open. You can then make changes to the template in the Source Editor.
 */

package com.reportnan.objdb;
import com.hospital_os.usecase.connection.ConnectionInf;
import com.reportnan.utility.Language;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.util.Vector;
/**
 *
 * @author pu
 */
public class RPPatientNCDDB
{
    ConnectionInf theConnectionInf;
    String SQL = "";
    Vector vc;
    ResultSet rs = null;
    ResultSetMetaData metadata;
    Vector vString;
    Vector vData;
    private int columnsize;
    private int str;
    StringBuffer strBuffer;
    /** Creates a new instance of RPPatientNCDDB */
    public RPPatientNCDDB(ConnectionInf conf)
    {
        theConnectionInf = conf;
    }
    
    /**
     *รายงาน NCD
     *@return Vector ของผู้ป่วย NCD
     *@Author pu
     *@Date 19/06/2006
     */
    public Vector queryPaitentNCD(String year,String month)
    {
       strBuffer = new StringBuffer();
        try
        {
        SQL = "SELECT " +
                "'01' AS num " +
                ",'visit_ncd' AS activity " +
                ",sum(case when q_visit_ncd.day_visit = '01' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_1 " +
                ",sum(case when q_visit_ncd.day_visit = '02' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_2 " +
                ",sum(case when q_visit_ncd.day_visit = '03' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_3 " +
                ",sum(case when q_visit_ncd.day_visit = '04' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_4 " +
                ",sum(case when q_visit_ncd.day_visit = '05' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_5 " +
                ",sum(case when q_visit_ncd.day_visit = '06' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_6 " +
                ",sum(case when q_visit_ncd.day_visit = '07' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_7 " +
                ",sum(case when q_visit_ncd.day_visit = '08' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_8 " +
                ",sum(case when q_visit_ncd.day_visit = '09' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_9 " +
                ",sum(case when q_visit_ncd.day_visit = '10' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_10 " +
                ",sum(case when q_visit_ncd.day_visit = '11' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_11 " +
                ",sum(case when q_visit_ncd.day_visit = '12' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_12 " +
                ",sum(case when q_visit_ncd.day_visit = '13' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_13 " +
                ",sum(case when q_visit_ncd.day_visit = '14' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_14 " +
                ",sum(case when q_visit_ncd.day_visit = '15' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_15 " +
                ",sum(case when q_visit_ncd.day_visit = '16' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_16 " +
                 ",sum(case when q_visit_ncd.day_visit = '17' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_17 " +
                 ",sum(case when q_visit_ncd.day_visit = '18' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_18 " +
                 ",sum(case when q_visit_ncd.day_visit = '19' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_19 " +
                 ",sum(case when q_visit_ncd.day_visit = '20' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_20 " +
                 ",sum(case when q_visit_ncd.day_visit = '21' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_21 " +
                 ",sum(case when q_visit_ncd.day_visit = '22' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_22 " +
                 ",sum(case when q_visit_ncd.day_visit = '23' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_23 " +
                 ",sum(case when q_visit_ncd.day_visit = '24' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_24 " +
                 ",sum(case when q_visit_ncd.day_visit = '25' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_25 " +
                 ",sum(case when q_visit_ncd.day_visit = '26' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_26 " +
                 ",sum(case when q_visit_ncd.day_visit = '27' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_27 " +
                 ",sum(case when q_visit_ncd.day_visit = '28' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_28 " +
                 ",sum(case when q_visit_ncd.day_visit = '29' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_29 " +
                 ",sum(case when q_visit_ncd.day_visit = '30' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_30 " +
                 ",sum(case when q_visit_ncd.day_visit = '31' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_31 " +
                 ",sum(1) AS all_day " +
            "FROM " +
            "(select " +
                    "t_visit.t_visit_id " +
                    ",substring(t_visit.visit_begin_visit_time,9,2) AS day_visit " +
            "from " +
                "t_visit INNER JOIN t_visit_service " +
                "ON t_visit.t_visit_id = t_visit_service.t_visit_id " +
            "where " +
                "t_visit.f_visit_status_id <> '4' " +
                "and t_visit.f_visit_type_id = '0' " +
                "and t_visit.visit_ncd = '1' " +
                "and substring(t_visit.visit_begin_visit_time,1,4) = '" +year + "' " +
                "and substring(t_visit.visit_begin_visit_time,6,2) = '" + month + "' " +
                "and t_visit_service.b_service_point_id IN (SELECT r_service_point_type_map.b_service_point_id " +
                            "FROM r_service_point_type INNER JOIN r_service_point_type_map " +
                                    "ON r_service_point_type.r_service_point_type_id = r_service_point_type_map.r_service_point_type_id " + 
                            "WHERE  r_service_point_type.service_point_type_number = '3') " +
            "group by " + 
                    "t_visit.t_visit_id,day_visit " +
            ") AS q_visit_ncd " +

            "UNION " +

            "SELECT " +
                "'02' AS num " +
                ",q_ncd.ncd_group_description AS activity " +
                ",sum(case when q_ncd.day_visit = '01' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_1 " +
                ",sum(case when q_ncd.day_visit = '02' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_2 " +
                ",sum(case when q_ncd.day_visit = '03' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_3 " +
                ",sum(case when q_ncd.day_visit = '04' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_4 " +
                ",sum(case when q_ncd.day_visit = '05' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_5 " +
                ",sum(case when q_ncd.day_visit = '06' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_6 " +
                ",sum(case when q_ncd.day_visit = '07' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_7 " +
                ",sum(case when q_ncd.day_visit = '08' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_8 " +
                ",sum(case when q_ncd.day_visit = '09' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_9 " +
                ",sum(case when q_ncd.day_visit = '10' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_10 " +
                ",sum(case when q_ncd.day_visit = '11' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_11 " +
                ",sum(case when q_ncd.day_visit = '12' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_12 " +
                ",sum(case when q_ncd.day_visit = '13' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_13 " +
                ",sum(case when q_ncd.day_visit = '14' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_14 " +
                ",sum(case when q_ncd.day_visit = '15' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_15 " +
                ",sum(case when q_ncd.day_visit = '16' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_16 " +
                 ",sum(case when q_ncd.day_visit = '17' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_17 " +
                 ",sum(case when q_ncd.day_visit = '18' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_18 " +
                 ",sum(case when q_ncd.day_visit = '19' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_19 " +
                 ",sum(case when q_ncd.day_visit = '20' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_20 " +
                 ",sum(case when q_ncd.day_visit = '21' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_21 " +
                 ",sum(case when q_ncd.day_visit = '22' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_22 " +
                 ",sum(case when q_ncd.day_visit = '23' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_23 " +
                 ",sum(case when q_ncd.day_visit = '24' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_24 " +
                 ",sum(case when q_ncd.day_visit = '25' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_25 " +
                 ",sum(case when q_ncd.day_visit = '26' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_26 " +
                 ",sum(case when q_ncd.day_visit = '27' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_27 " +
                 ",sum(case when q_ncd.day_visit = '28' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_28 " +
                 ",sum(case when q_ncd.day_visit = '29' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_29 " +
                 ",sum(case when q_ncd.day_visit = '30' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_30 " +
                 ",sum(case when q_ncd.day_visit = '31' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_31 " +
                 ",sum(1) AS all_day " +
            "FROM " +
            "(select " +
                    "t_visit.t_visit_id " +
                    ",b_ncd_group.ncd_group_description AS ncd_group_description " +
                    ",substring(t_visit.visit_begin_visit_time,9,2) AS day_visit " +
            "from " +
                "t_visit INNER JOIN b_ncd_group  " +
                "ON t_visit.b_ncd_group_id = b_ncd_group.b_ncd_group_id " +
                "INNER JOIN t_visit_service " +
                "ON t_visit.t_visit_id = t_visit_service.t_visit_id " +
            "where " +
                "t_visit.f_visit_status_id <> '4' " +
                "and t_visit.f_visit_type_id = '0' " +
                "and t_visit.visit_ncd = '1' " +
                "and substring(t_visit.visit_begin_visit_time,1,4) = '" +year + "' " +
                "and substring(t_visit.visit_begin_visit_time,6,2) = '" + month + "' " +
                "and t_visit_service.b_service_point_id IN (SELECT r_service_point_type_map.b_service_point_id " +
                            "FROM r_service_point_type INNER JOIN r_service_point_type_map " +
                                    "ON r_service_point_type.r_service_point_type_id = r_service_point_type_map.r_service_point_type_id " + 
                            "WHERE  r_service_point_type.service_point_type_number = '3') " +
            "group by " + 
                    "t_visit.t_visit_id,b_ncd_group.ncd_group_description,day_visit " +
            ") AS q_ncd " +
            "GROUP BY " +
                    "q_ncd.ncd_group_description ";
            strBuffer.append(SQL);
            SQL = "UNION " +

            "SELECT " +
            "'03' AS num " +
            ",'patient_appoint' AS  activity " +
            ",sum(case when substring(patient_appointment_date,9,2) = '01' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_1 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '02' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_2 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '03' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_3 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '04' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_4 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '05' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_5 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '06' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_6 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '07' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_7 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '08' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_8 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '09' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_9 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '10' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_10 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '11' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_11 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '12' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_12 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '13' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_13 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '14' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_14 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '15' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_15 " +
                ",sum(case when substring(patient_appointment_date,9,2) = '16' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_16 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '17' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_17 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '18' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_18 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '19' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_19 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '20' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_20 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '21' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_21 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '22' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_22 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '23' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_23 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '24' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_24 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '25' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_25 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '26' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_26 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '27' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_27 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '28' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_28 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '29' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_29 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '30' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_30 " +
                 ",sum(case when substring(patient_appointment_date,9,2) = '31' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_31 " +
                 ",sum(1) AS all_day " +
            "FROM " +
                    "t_patient_appointment " +
            "WHERE " +
                    "patient_appointment_active = '1' " +
                    "and substring(patient_appointment_date,1,4) = '" +year + "' " +
                    "and substring(patient_appointment_date,6,2) = '" + month + "' " +
                    "and t_patient_appointment.patient_appointment_clinic IN (SELECT r_service_point_type_map.b_service_point_id " +
                            "FROM r_service_point_type INNER JOIN r_service_point_type_map " +
                                    "ON r_service_point_type.r_service_point_type_id = r_service_point_type_map.r_service_point_type_id " + 
                            "WHERE  r_service_point_type.service_point_type_number = '3') " +

            "UNION " +

            "select " +
            "'04' AS num " +
            ",f_appointment_status.appointment_status_name AS  activity " +
            ",sum(case when q_appoint.day_appoint = '01' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_1 " +
                ",sum(case when q_appoint.day_appoint = '02' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_2 " +
                ",sum(case when q_appoint.day_appoint = '03' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_3 " +
                ",sum(case when q_appoint.day_appoint = '04' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_4 " +
                ",sum(case when q_appoint.day_appoint = '05' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_5 " +
                ",sum(case when q_appoint.day_appoint = '06' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_6 " +
                ",sum(case when q_appoint.day_appoint = '07' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_7 " +
                ",sum(case when q_appoint.day_appoint = '08' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_8 " +
                ",sum(case when q_appoint.day_appoint = '09' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_9 " +
                ",sum(case when q_appoint.day_appoint = '10' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_10 " +
                ",sum(case when q_appoint.day_appoint = '11' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_11 " +
                ",sum(case when q_appoint.day_appoint = '12' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_12 " +
                ",sum(case when q_appoint.day_appoint = '13' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_13 " +
                ",sum(case when q_appoint.day_appoint = '14' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_14 " +
                ",sum(case when q_appoint.day_appoint = '15' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_15 " +
                ",sum(case when q_appoint.day_appoint = '16' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_16 " +
                 ",sum(case when q_appoint.day_appoint = '17' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_17 " +
                 ",sum(case when q_appoint.day_appoint = '18' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_18 " +
                 ",sum(case when q_appoint.day_appoint = '19' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_19 " +
                 ",sum(case when q_appoint.day_appoint = '20' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_20 " +
                 ",sum(case when q_appoint.day_appoint = '21' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_21 " +
                 ",sum(case when q_appoint.day_appoint = '22' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_22 " +
                 ",sum(case when q_appoint.day_appoint = '23' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_23 " +
                 ",sum(case when q_appoint.day_appoint = '24' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_24 " +
                 ",sum(case when q_appoint.day_appoint = '25' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_25 " +
                 ",sum(case when q_appoint.day_appoint = '26' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_26 " +
                 ",sum(case when q_appoint.day_appoint = '27' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_27 " +
                 ",sum(case when q_appoint.day_appoint = '28' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_28 " +
                 ",sum(case when q_appoint.day_appoint = '29' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_29 " +
                 ",sum(case when q_appoint.day_appoint = '30' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_30 " +
                 ",sum(case when q_appoint.day_appoint = '31' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_31 " +
                 ",sum(case when q_appoint.status IS NOT NULL " + 
                    "then 1 " + 
                    "else 0 " + 
                 "end) AS all_day " +
            "from " +
            "f_appointment_status " +
            "LEFT JOIN " + 
                    "(select " + 
                        "patient_appointment_status AS status " +
                        ",substring(patient_appointment_date,9,2) AS  day_appoint " +
                    "from " +
                        "t_patient_appointment " +
                    "where " +
                        "patient_appointment_active = '1' " +
                        "and substring(patient_appointment_date,1,4) = '" +year + "' " +
                        "and substring(patient_appointment_date,6,2) = '" + month + "' " +
                        "and t_patient_appointment.patient_appointment_clinic IN (SELECT r_service_point_type_map.b_service_point_id " +
                            "FROM r_service_point_type INNER JOIN r_service_point_type_map " +
                                    "ON r_service_point_type.r_service_point_type_id = r_service_point_type_map.r_service_point_type_id " + 
                            "WHERE  r_service_point_type.service_point_type_number = '3') " +
                    ") AS q_appoint " +
            "ON f_appointment_status.f_appointment_status_id = q_appoint.status " +
            "group by " +
            "activity, num ";
             strBuffer.append(SQL);

            SQL = "UNION " +

            "SELECT " +
              "'05' AS num " +
              ", 'refer_in'  AS activity " +
                ",sum(case when q_refer_in.day_visit  = '01' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_1 " +
                ",sum(case when q_refer_in.day_visit  = '02' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_2 " +
                ",sum(case when q_refer_in.day_visit  = '03' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_3 " +
                ",sum(case when q_refer_in.day_visit  = '04' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_4 " +
                ",sum(case when q_refer_in.day_visit  = '05' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_5 " +
                ",sum(case when q_refer_in.day_visit  = '06' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_6 " +
                ",sum(case when q_refer_in.day_visit  = '07' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_7 " +
                ",sum(case when q_refer_in.day_visit  = '08' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_8 " +
                ",sum(case when q_refer_in.day_visit  = '09' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_9 " +
                ",sum(case when q_refer_in.day_visit  = '10' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_10 " +
                ",sum(case when q_refer_in.day_visit  = '11' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_11 " +
                ",sum(case when q_refer_in.day_visit  = '12' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_12 " +
                ",sum(case when q_refer_in.day_visit  = '13' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_13 " +
                ",sum(case when q_refer_in.day_visit  = '14' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_14 " +
                ",sum(case when q_refer_in.day_visit  = '15' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_15 " +
                ",sum(case when q_refer_in.day_visit  = '16' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_16 " +
                 ",sum(case when q_refer_in.day_visit  = '17' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_17 " +
                 ",sum(case when q_refer_in.day_visit  = '18' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_18 " +
                 ",sum(case when q_refer_in.day_visit  = '19' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_19 " +
                 ",sum(case when q_refer_in.day_visit  = '20' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_20 " +
                 ",sum(case when q_refer_in.day_visit  = '21' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_21 " +
                 ",sum(case when q_refer_in.day_visit  = '22' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_22 " +
                 ",sum(case when q_refer_in.day_visit  = '23' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_23 " +
                 ",sum(case when q_refer_in.day_visit  = '24' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_24 " +
                 ",sum(case when q_refer_in.day_visit  = '25' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_25 " +
                 ",sum(case when q_refer_in.day_visit  = '26' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_26 " +
                 ",sum(case when q_refer_in.day_visit  = '27' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_27 " +
                 ",sum(case when q_refer_in.day_visit  = '28' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_28 " +
                 ",sum(case when q_refer_in.day_visit  = '29' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_29 " +
                 ",sum(case when q_refer_in.day_visit  = '30' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_30 " +
                 ",sum(case when q_refer_in.day_visit = '31' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_31 " +
                ", count(*) AS count_visit " +
            "FROM " +
            "(select " + 
                 "t_visit.t_visit_id " +
                 ", substring(t_visit.visit_begin_visit_time,9,2) AS day_visit " +
            "from " +
                "t_visit INNER JOIN t_visit_service " +
                "ON t_visit.t_visit_id = t_visit_service.t_visit_id " + 
                "INNER JOIN r_refer_office " +
                "ON t_visit.b_visit_office_id_refer_in = r_refer_office.refer_office_code " +
            "where " +
                "t_visit.f_visit_status_id <> '4' " +
                "and t_visit.f_visit_type_id = '0' " +
                "and t_visit.visit_ncd = '1' " +
                "and r_refer_office.r_refer_office_type_id  = '01' " +
                "and substring(t_visit.visit_begin_visit_time,1,4) = '" +year + "' " +
                "and substring(t_visit.visit_begin_visit_time,6,2) = '" + month + "' " +
                "and t_visit_service.b_service_point_id IN (SELECT r_service_point_type_map.b_service_point_id " +
                            "FROM r_service_point_type INNER JOIN r_service_point_type_map " +
                                    "ON r_service_point_type.r_service_point_type_id = r_service_point_type_map.r_service_point_type_id " + 
                            "WHERE  r_service_point_type.service_point_type_number = '3') " +
            "group by " +
                    "t_visit.t_visit_id,day_visit " +
            ") AS q_refer_in " +

            "UNION " +

            "SELECT " +
              "'06' AS num " +
              ", 'refer_out'  AS activity " +
                ",sum(case when q_refer_out.day_visit  = '01' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_1 " +
                ",sum(case when q_refer_out.day_visit  = '02' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_2 " +
                ",sum(case when q_refer_out.day_visit  = '03' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_3 " +
                ",sum(case when q_refer_out.day_visit  = '04' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_4 " +
                ",sum(case when q_refer_out.day_visit  = '05' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_5 " +
                ",sum(case when q_refer_out.day_visit  = '06' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_6 " +
                ",sum(case when q_refer_out.day_visit  = '07' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_7 " +
                ",sum(case when q_refer_out.day_visit  = '08' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_8 " +
                ",sum(case when q_refer_out.day_visit  = '09' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_9 " +
                ",sum(case when q_refer_out.day_visit  = '10' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_10 " +
                ",sum(case when q_refer_out.day_visit  = '11' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_11 " +
                ",sum(case when q_refer_out.day_visit  = '12' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_12 " +
                ",sum(case when q_refer_out.day_visit  = '13' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_13 " +
                ",sum(case when q_refer_out.day_visit  = '14' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_14 " +
                ",sum(case when q_refer_out.day_visit  = '15' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_15 " +
                ",sum(case when q_refer_out.day_visit  = '16' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_16 " +
                 ",sum(case when q_refer_out.day_visit  = '17' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_17 " +
                 ",sum(case when q_refer_out.day_visit  = '18' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_18 " +
                 ",sum(case when q_refer_out.day_visit  = '19' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_19 " +
                 ",sum(case when q_refer_out.day_visit  = '20' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_20 " +
                 ",sum(case when q_refer_out.day_visit  = '21' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_21 " +
                 ",sum(case when q_refer_out.day_visit  = '22' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_22 " +
                 ",sum(case when q_refer_out.day_visit  = '23' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_23 " +
                 ",sum(case when q_refer_out.day_visit  = '24' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_24 " +
                 ",sum(case when q_refer_out.day_visit  = '25' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_25 " +
                 ",sum(case when q_refer_out.day_visit  = '26' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_26 " +
                 ",sum(case when q_refer_out.day_visit  = '27' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_27 " +
                 ",sum(case when q_refer_out.day_visit  = '28' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_28 " +
                 ",sum(case when q_refer_out.day_visit  = '29' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_29 " +
                 ",sum(case when q_refer_out.day_visit  = '30' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_30 " +
                 ",sum(case when q_refer_out.day_visit = '31' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_31 " +
                ", count(*) AS count_visit " +
            "FROM " +
            "(select " + 
                 "t_visit.t_visit_id " +
                 ", substring(t_visit.visit_begin_visit_time,9,2) AS day_visit " +
            "from " +
                "t_visit INNER JOIN t_visit_service " +
                "ON t_visit.t_visit_id = t_visit_service.t_visit_id " + 
                "INNER JOIN r_refer_office " +
                "ON t_visit.b_visit_office_id_refer_out = r_refer_office.refer_office_code " +
            "where " +
                "t_visit.f_visit_status_id <> '4' " +
                "and t_visit.f_visit_type_id = '0' " +
                "and t_visit.visit_ncd = '1' " +
                "and r_refer_office.r_refer_office_type_id  = '01' " +
                "and substring(t_visit.visit_begin_visit_time,1,4) = '" +year + "' " +
                "and substring(t_visit.visit_begin_visit_time,6,2) = '" + month + "' " +
                "and t_visit_service.b_service_point_id IN (SELECT r_service_point_type_map.b_service_point_id " +
                            "FROM r_service_point_type INNER JOIN r_service_point_type_map " +
                                    "ON r_service_point_type.r_service_point_type_id = r_service_point_type_map.r_service_point_type_id " + 
                            "WHERE  r_service_point_type.service_point_type_number = '3') " +
            "group by " +
                    "t_visit.t_visit_id,day_visit " +
            ") AS q_refer_out " +

            "UNION " +

            "SELECT " +
                "'07' AS num " +
                ",'admission' AS activity " +
                ",sum(case when q_admit.day_visit = '01' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_1 " +
                ",sum(case when q_admit.day_visit = '02' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_2 " +
                ",sum(case when q_admit.day_visit = '03' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_3 " +
                ",sum(case when q_admit.day_visit = '04' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_4 " +
                ",sum(case when q_admit.day_visit = '05' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_5 " +
                ",sum(case when q_admit.day_visit = '06' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_6 " +
                ",sum(case when q_admit.day_visit = '07' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_7 " +
                ",sum(case when q_admit.day_visit = '08' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_8 " +
                ",sum(case when q_admit.day_visit = '09' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_9 " +
                ",sum(case when q_admit.day_visit = '10' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_10 " +
                ",sum(case when q_admit.day_visit = '11' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_11 " +
                ",sum(case when q_admit.day_visit = '12' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_12 " +
                ",sum(case when q_admit.day_visit = '13' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_13 " +
                ",sum(case when q_admit.day_visit = '14' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_14 " +
                ",sum(case when q_admit.day_visit = '15' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_15 " +
                ",sum(case when q_admit.day_visit = '16' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_16 " +
                 ",sum(case when q_admit.day_visit = '17' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_17 " +
                 ",sum(case when q_admit.day_visit = '18' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_18 " +
                 ",sum(case when q_admit.day_visit = '19' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_19 " +
                 ",sum(case when q_admit.day_visit = '20' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_20 " +
                 ",sum(case when q_admit.day_visit = '21' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_21 " +
                 ",sum(case when q_admit.day_visit = '22' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_22 " +
                 ",sum(case when q_admit.day_visit = '23' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_23 " +
                 ",sum(case when q_admit.day_visit = '24' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_24 " +
                 ",sum(case when q_admit.day_visit = '25' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_25 " +
                 ",sum(case when q_admit.day_visit = '26' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_26 " +
                 ",sum(case when q_admit.day_visit = '27' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_27 " +
                 ",sum(case when q_admit.day_visit = '28' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_28 " +
                 ",sum(case when q_admit.day_visit = '29' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_29 " +
                 ",sum(case when q_admit.day_visit = '30' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_30 " +
                 ",sum(case when q_admit.day_visit = '31' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_31 " +
                 ",sum(1) AS all_day " +
            "FROM " +
            "(select " +
                    "t_visit.t_visit_id " +
                    ",substring(t_visit.visit_begin_visit_time,9,2) AS day_visit " +
            "from " +
                "t_visit INNER JOIN t_visit_service " +
                "ON t_visit.t_visit_id = t_visit_service.t_visit_id " +
            "where " +
                "t_visit.f_visit_status_id <> '4' " +
                "and t_visit.f_visit_type_id = '1' " +
                "and t_visit.visit_ncd = '1' " +
                "and substring(t_visit.visit_begin_visit_time,1,4) = '" +year + "' " +
                "and substring(t_visit.visit_begin_visit_time,6,2) = '" + month + "' " +
                "and t_visit_service.b_service_point_id IN (SELECT r_service_point_type_map.b_service_point_id " +
                            "FROM r_service_point_type INNER JOIN r_service_point_type_map " +
                                    "ON r_service_point_type.r_service_point_type_id = r_service_point_type_map.r_service_point_type_id " + 
                            "WHERE  r_service_point_type.service_point_type_number = '3') " +
            "group by " + 
                    "t_visit.t_visit_id,day_visit " +
            ") AS q_admit ";
            strBuffer.append(SQL);
            SQL = " UNION " +

            "SELECT " +
                "'08' AS num " +
                ",q_visit_ncd_doctor.doctor_name AS activity " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '01' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_1 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '02' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_2 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '03' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_3 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '04' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_4 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '05' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_5 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '06' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_6 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '07' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_7 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '08' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_8 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '09' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_9 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '10' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_10 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '11' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_11 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '12' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_12 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '13' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_13 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '14' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_14 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '15' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_15 " +
                ",sum(case when q_visit_ncd_doctor.day_visit = '16' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_16 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '17' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_17 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '18' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_18 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '19' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_19 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '20' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_20 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '21' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_21 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '22' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_22 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '23' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_23 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '24' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_24 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '25' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_25 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '26' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_26 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '27' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_27 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '28' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_28 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '29' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_29 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '30' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_30 " +
                 ",sum(case when q_visit_ncd_doctor.day_visit = '31' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_31 " +
                 ",sum(1) AS all_day " +
            "FROM " +
            "(select " +
                    "t_visit.t_visit_id " +
                    ", (employee_firstname || '  ' || employee_lastname) AS doctor_name " +
                    ",substring(t_visit.visit_begin_visit_time,9,2) AS day_visit " +
            "from " +
                "t_visit INNER JOIN t_visit_service " +
                "ON t_visit.t_visit_id = t_visit_service.t_visit_id " +
                "INNER JOIN t_visit_service as t_visit_service_doctor " +
                "ON t_visit.t_visit_id = t_visit_service_doctor.t_visit_id and t_visit_service_doctor.visit_service_staff_doctor <> '' " +
                            "and t_visit_service_doctor.visit_service_staff_doctor <> 'null' " +
                "INNER JOIN b_employee " +
                "ON b_employee.b_employee_id = t_visit_service_doctor.visit_service_staff_doctor " +
            "where " +
                "t_visit.f_visit_status_id <> '4' " +
                "and t_visit.f_visit_type_id = '0' " +
                "and t_visit.visit_ncd = '1' " +
                "and substring(t_visit.visit_begin_visit_time,1,4) = '" +year + "' " +
                "and substring(t_visit.visit_begin_visit_time,6,2) = '" + month + "' " +
                "and t_visit_service.b_service_point_id IN (SELECT r_service_point_type_map.b_service_point_id " +
                            "FROM r_service_point_type INNER JOIN r_service_point_type_map " +
                                    "ON r_service_point_type.r_service_point_type_id = r_service_point_type_map.r_service_point_type_id " + 
                            "WHERE  r_service_point_type.service_point_type_number = '3') " +
            "group by " + 
                    "t_visit.t_visit_id,doctor_name,day_visit " +
            ") AS q_visit_ncd_doctor " +
            "GROUP BY " +
                    "q_visit_ncd_doctor.doctor_name " +

            "UNION " +

            "SELECT " +
                "'09' AS num " +
                ",q_dm_fbs.activity AS activity " +
                ",sum(case when q_dm_fbs.day_visit = '01' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_1 " +
                ",sum(case when q_dm_fbs.day_visit = '02' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_2 " +
                ",sum(case when q_dm_fbs.day_visit = '03' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_3 " +
                ",sum(case when q_dm_fbs.day_visit = '04' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_4 " +
                ",sum(case when q_dm_fbs.day_visit = '05' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_5 " +
                ",sum(case when q_dm_fbs.day_visit = '06' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_6 " +
                ",sum(case when q_dm_fbs.day_visit = '07' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_7 " +
                ",sum(case when q_dm_fbs.day_visit = '08' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_8 " +
                ",sum(case when q_dm_fbs.day_visit = '09' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_9 " +
                ",sum(case when q_dm_fbs.day_visit = '10' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_10 " +
                ",sum(case when q_dm_fbs.day_visit = '11' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_11 " +
                ",sum(case when q_dm_fbs.day_visit = '12' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_12 " +
                ",sum(case when q_dm_fbs.day_visit = '13' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_13 " +
                ",sum(case when q_dm_fbs.day_visit = '14' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_14 " +
                ",sum(case when q_dm_fbs.day_visit = '15' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_15 " +
                ",sum(case when q_dm_fbs.day_visit = '16' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_16 " +
                 ",sum(case when q_dm_fbs.day_visit = '17' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_17 " +
                 ",sum(case when q_dm_fbs.day_visit = '18' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_18 " +
                 ",sum(case when q_dm_fbs.day_visit = '19' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_19 " +
                 ",sum(case when q_dm_fbs.day_visit = '20' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_20 " +
                 ",sum(case when q_dm_fbs.day_visit = '21' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_21 " +
                 ",sum(case when q_dm_fbs.day_visit = '22' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_22 " +
                 ",sum(case when q_dm_fbs.day_visit = '23' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_23 " +
                 ",sum(case when q_dm_fbs.day_visit = '24' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_24 " +
                 ",sum(case when q_dm_fbs.day_visit = '25' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_25 " +
                 ",sum(case when q_dm_fbs.day_visit = '26' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_26 " +
                 ",sum(case when q_dm_fbs.day_visit = '27' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_27 " +
                 ",sum(case when q_dm_fbs.day_visit = '28' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_28 " +
                 ",sum(case when q_dm_fbs.day_visit = '29' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_29 " +
                 ",sum(case when q_dm_fbs.day_visit = '30' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_30 " +
                 ",sum(case when q_dm_fbs.day_visit = '31' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_31 " +
                 ",sum(1) AS all_day " +
            "FROM " +
            "(select " +
                    "t_visit.t_visit_id " +
                    ",case when (to_number(t_result_lab.result_lab_value,'999') < 80) " +
                            "then 'dm_fbs_<80' " +
                            "when (to_number(t_result_lab.result_lab_value,'999') > 140) " +
                            "then 'dm_fbs_>140' " +
                            "else 'dm_fbs_80-140' " +
                    "end AS activity " +
                    ",substring(t_visit.visit_begin_visit_time,9,2) AS day_visit " +
            "from " +
                "t_visit INNER JOIN t_diag_icd10 " + 
                "ON (t_visit.t_visit_id = t_diag_icd10.diag_icd10_vn " +  
                            "and t_diag_icd10.diag_icd10_active = '1' " + 
                            "and substr(t_diag_icd10.diag_icd10_number,1,3) Between 'E10' and 'E14') " +
                "INNER JOIN t_order " +
                "ON t_visit.t_visit_id = t_order.t_visit_id " +
                "INNER JOIN  t_result_lab " +
                "ON  t_order.t_order_id = t_result_lab.t_order_id " +
            "where " +
                "t_visit.f_visit_status_id <> '4' " +
                "and t_visit.f_visit_type_id = '0' " +
                "and t_visit.visit_ncd = '1' " +
                "and t_order.f_order_status_id  = '4' " +
                "and t_result_lab.result_lab_active = '1' " +
                "and substring(t_visit.visit_begin_visit_time,1,4) = '" +year + "' " +
                "and substring(t_visit.visit_begin_visit_time,6,2) = '" + month + "' " +
                "and t_order.b_item_id IN (SELECT r_ncd_item_group_map_item.b_item_id " +
                            "FROM r_ncd_item_group_map_item INNER JOIN r_ncd_item_group " +
                                    "ON r_ncd_item_group_map_item.r_ncd_item_group_id = r_ncd_item_group.r_ncd_item_group_id  " +
                            "WHERE  r_ncd_item_group.ncd_item_group_number = '1') " +
            "group by " + 
                    "t_visit.t_visit_id,activity,day_visit " +
            ") AS q_dm_fbs " +
            "GROUP BY  " +
                    "q_dm_fbs.activity ";

            strBuffer.append(SQL);
            SQL = " UNION " +

            "SELECT " +
                "'10' AS num " +
                ",q_ht_bp.activity AS activity " +
                ",sum(case when q_ht_bp.day_visit = '01' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_1 " +
                ",sum(case when q_ht_bp.day_visit = '02' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_2 " +
                ",sum(case when q_ht_bp.day_visit = '03' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_3 " +
                ",sum(case when q_ht_bp.day_visit = '04' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_4 " +
                ",sum(case when q_ht_bp.day_visit = '05' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_5 " +
                ",sum(case when q_ht_bp.day_visit = '06' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_6 " +
                ",sum(case when q_ht_bp.day_visit = '07' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_7 " +
                ",sum(case when q_ht_bp.day_visit = '08' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_8 " +
                ",sum(case when q_ht_bp.day_visit = '09' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_9 " +
                ",sum(case when q_ht_bp.day_visit = '10' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_10 " +
                ",sum(case when q_ht_bp.day_visit = '11' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_11 " +
                ",sum(case when q_ht_bp.day_visit = '12' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_12 " +
                ",sum(case when q_ht_bp.day_visit = '13' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_13 " +
                ",sum(case when q_ht_bp.day_visit = '14' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_14 " +
                ",sum(case when q_ht_bp.day_visit = '15' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_15 " +
                ",sum(case when q_ht_bp.day_visit = '16' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_16 " +
                 ",sum(case when q_ht_bp.day_visit = '17' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_17 " +
                 ",sum(case when q_ht_bp.day_visit = '18' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_18 " +
                 ",sum(case when q_ht_bp.day_visit = '19' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_19 " +
                 ",sum(case when q_ht_bp.day_visit = '20' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_20 " +
                 ",sum(case when q_ht_bp.day_visit = '21' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_21 " +
                 ",sum(case when q_ht_bp.day_visit = '22' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_22 " +
                 ",sum(case when q_ht_bp.day_visit = '23' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_23 " +
                 ",sum(case when q_ht_bp.day_visit = '24' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_24 " +
                 ",sum(case when q_ht_bp.day_visit = '25' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_25 " +
                 ",sum(case when q_ht_bp.day_visit = '26' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_26 " +
                 ",sum(case when q_ht_bp.day_visit = '27' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_27 " +
                 ",sum(case when q_ht_bp.day_visit = '28' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_28 " +
                 ",sum(case when q_ht_bp.day_visit = '29' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_29 " +
                 ",sum(case when q_ht_bp.day_visit = '30' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_30 " +
                 ",sum(case when q_ht_bp.day_visit = '31' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_31 " +
                 ",sum(1) AS all_day " +
            "FROM " +
            "(select " +
                    "t_visit.t_visit_id " +
                    ", case when to_number(substring(t_visit_vital_sign.visit_vital_sign_blood_presure,1,length(t_visit_vital_sign.visit_vital_sign_blood_presure) " + 
                            "- length(substring(t_visit_vital_sign.visit_vital_sign_blood_presure " +
                            ",(position('/' IN t_visit_vital_sign.visit_vital_sign_blood_presure))))) , '999') < 140 " +
                                            "or  " +
                                            "to_number(substring(t_visit_vital_sign.visit_vital_sign_blood_presure " +
                            ",(position('/' IN t_visit_vital_sign.visit_vital_sign_blood_presure) +1 )),'999') < 90 " +
                            "then 'ht_bp_<140/90' " +
                            "else 'ht_bp_>=140/90' " +
                    "end AS activity " +
                    ",substring(t_visit.visit_begin_visit_time,9,2) AS day_visit " +
            "from " +
                "t_visit INNER JOIN t_diag_icd10 " +
                "ON (t_visit.t_visit_id = t_diag_icd10.diag_icd10_vn " +  
                            "and t_diag_icd10.diag_icd10_active = '1' " +
                            "and substr(t_diag_icd10.diag_icd10_number,1,3) Between 'I11' and 'I15') " +
                "INNER JOIN t_visit_vital_sign " +
                "ON (t_visit.t_visit_id = t_visit_vital_sign.t_visit_id " + 
                            "and t_visit_vital_sign.visit_vital_sign_blood_presure <> '' ) " +
            "where " +
                "t_visit.f_visit_status_id <> '4' " +
                "and t_visit.f_visit_type_id = '0' " +
                "and t_visit.visit_ncd = '1' " +
                "and substring(t_visit.visit_begin_visit_time,1,4) = '" +year + "' " +
                "and substring(t_visit.visit_begin_visit_time,6,2) = '" + month + "' " +
            "group by " + 
                    "t_visit.t_visit_id,activity,day_visit " +
            ") AS q_ht_bp " +
            "GROUP BY  " +
                    "q_ht_bp.activity " +

            "UNION " +

            "SELECT " +
                "'11' AS num " +
                ",q_sent_visit_to.ncd_item_group AS activity " +
                ",sum(case when q_sent_visit_to.day_visit = '01' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_1 " +
                ",sum(case when q_sent_visit_to.day_visit = '02' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_2 " +
                ",sum(case when q_sent_visit_to.day_visit = '03' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_3 " +
                ",sum(case when q_sent_visit_to.day_visit = '04' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_4 " +
                ",sum(case when q_sent_visit_to.day_visit = '05' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_5 " +
                ",sum(case when q_sent_visit_to.day_visit = '06' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_6 " +
                ",sum(case when q_sent_visit_to.day_visit = '07' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_7 " +
                ",sum(case when q_sent_visit_to.day_visit = '08' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_8 " +
                ",sum(case when q_sent_visit_to.day_visit = '09' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_9 " +
                ",sum(case when q_sent_visit_to.day_visit = '10' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_10 " +
                ",sum(case when q_sent_visit_to.day_visit = '11' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_11 " +
                ",sum(case when q_sent_visit_to.day_visit = '12' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_12 " +
                ",sum(case when q_sent_visit_to.day_visit = '13' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_13 " +
                ",sum(case when q_sent_visit_to.day_visit = '14' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_14 " +
                ",sum(case when q_sent_visit_to.day_visit = '15' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_15 " +
                ",sum(case when q_sent_visit_to.day_visit = '16' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_16 " +
                 ",sum(case when q_sent_visit_to.day_visit = '17' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_17 " +
                 ",sum(case when q_sent_visit_to.day_visit = '18' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_18 " +
                 ",sum(case when q_sent_visit_to.day_visit = '19' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_19 " +
                 ",sum(case when q_sent_visit_to.day_visit = '20' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_20 " +
                 ",sum(case when q_sent_visit_to.day_visit = '21' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_21 " +
                 ",sum(case when q_sent_visit_to.day_visit = '22' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_22 " +
                 ",sum(case when q_sent_visit_to.day_visit = '23' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_23 " +
                 ",sum(case when q_sent_visit_to.day_visit = '24' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_24 " +
                 ",sum(case when q_sent_visit_to.day_visit = '25' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_25 " +
                 ",sum(case when q_sent_visit_to.day_visit = '26' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_26 " +
                 ",sum(case when q_sent_visit_to.day_visit = '27' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_27 " +
                 ",sum(case when q_sent_visit_to.day_visit = '28' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_28 " +
                 ",sum(case when q_sent_visit_to.day_visit = '29' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_29 " +
                 ",sum(case when q_sent_visit_to.day_visit = '30' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_30 " +
                 ",sum(case when q_sent_visit_to.day_visit = '31' " +
                    "then 1 " +
                    "else 0 " +
                 "end) AS day_31 " +
                 ",sum(1) AS all_day " +
            "FROM " +
            "(select " +
                    "t_visit.t_visit_id " +
                    ",r_ncd_item_group.ncd_item_group_description AS  ncd_item_group " +
                    ",substring(t_visit.visit_begin_visit_time,9,2) AS day_visit " +
            "from " +
                "t_visit INNER JOIN t_order " +
                "ON t_visit.t_visit_id = t_order.t_visit_id " +
                "INNER JOIN r_ncd_item_group_map_item  " +
                "ON t_order.b_item_id = r_ncd_item_group_map_item.b_item_id " +
                "INNER JOIN r_ncd_item_group " +
                "ON r_ncd_item_group_map_item.r_ncd_item_group_id = r_ncd_item_group.r_ncd_item_group_id " +
            "where " +
                "t_visit.f_visit_status_id <> '4' " +
                "and t_visit.f_visit_type_id = '0' " +
                "and t_visit.visit_ncd = '1' " +
                "and t_order.f_order_status_id NOT IN ('0','3') " +
                "and substring(t_visit.visit_begin_visit_time,1,4) = '" +year + "' " +
                "and substring(t_visit.visit_begin_visit_time,6,2) = '" + month + "' " +
                "and r_ncd_item_group.ncd_item_group_number IN ('2','3') " +
            "group by " + 
                    "t_visit.t_visit_id,ncd_item_group,day_visit " +
            ") AS q_sent_visit_to " +
            "GROUP BY " +
                    "q_sent_visit_to.ncd_item_group ";
            strBuffer.append(SQL);
            SQL = strBuffer.toString();
            System.out.println(SQL);
            rs = theConnectionInf.eQuery(SQL);
            vc = getData(rs);
        }
        catch(Exception ex)
        {
            ex.printStackTrace();
        }
        finally
        {
            if(vc == null)
            {
                vc = null;
            }
        }
        return vc;        
    }
    
    private Vector getData(ResultSet resultset) throws Exception
    {
        int column = 0;
        String[] rowdata = null;
        String[] columnname = null;
        vString =  null;
        vData = new Vector();
        //ตรวจสอบค่า resultset
        if(rs!= null)
        {
            //ทำการรับข้อมูลส่วนหัว field
            metadata = rs.getMetaData();
            //นับจำนวน column
            column = metadata.getColumnCount();
            //init array ให้มีจำนวน เท่ากับ column
            columnname = new String[column-1];
            vString = new Vector();
            //ทำการให้ค่าชื่อ field ที่ get มา
            for(int i = 0 ; i < column-1;i++)
            {
                columnname[i] = metadata.getColumnLabel(i+2);
                columnname[i] = Language.getTextBundle(columnname[i].toUpperCase());
            }
            //ทำการให้ค่าของ field กับข้อมูล
            while(rs.next())
            {   rowdata = new String[column-1];
                for(int i = 0 ; i < column-1;i++)
                {
                    if(rs.getObject(i+2) == null)
                    {
                        rowdata[i] = "0";
                    }
                    else
                    {
                        rowdata[i] = Language.getTextBundle(rs.getString(i+2));
                    }
                }
                vString.add(rowdata);
            }
            vData.add(columnname);
            vData.add(vString);
        }
        return vData;
    }
}
