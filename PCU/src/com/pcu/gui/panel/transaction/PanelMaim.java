/*
 * PanelMaim.java
 *
 * Created on 3 มีนาคม 2549, 17:13 น.
 */

package com.pcu.gui.panel.transaction;
import com.pcu.control.PCUObject;
import com.pcu.gui.dialog.HosDialog;
import javax.swing.*;
import java.util.*;

import com.pcu .object.*;
import com.pcu.control.HosManage;
import com.pcu.control.AllComboBoxControl;
import com.pcu.utility.GutilPCU;
import com.pcu.utility.TableModel;
import com.pcu.utility.DateUtil;
import com.pcu.utility.DateTime;
import com.pcu.utility.DateComboBox;
import com.pcu.utility.*;
import com.hospital_os.object.Employee;
import com.hospital_os.object.Patient;
import com.hospital_os.object.Visit;
import com.hospital_os.utility.Gutil;
import com.hospital_os.utility.ComboboxModel;
import com.hospital_os.utility.*;
import com.hosv3.utility.connection.UpdateStatus;

/**
 *
 * @author  Jao
 */
public class PanelMaim extends javax.swing.JPanel {
     private JFrame theJFrame;
     private Family theFamily;
     private AllComboBoxControl theAllComboBoxControl;
     private Employee theEmployee;
     private Vector vMaim;
     private Maim theMaim;
     private Patient thePatient;
     private Visit theVisit;
     private DateComboBox dc;
     private UpdateStatus theUS;
     HosManage theHM;

    private PCUObject pcuobject;
    /** Creates new form PanelMaim */
    public PanelMaim() {
        initComponents();
    }
    
    public PanelMaim(HosManage hm) {
        initComponents();
        setControl(hm,null);
    }
    
    public void setControl(HosManage hm,HosDialog hd)
     {
        theHM = hm;
        pcuobject = hm.thePO;
        theAllComboBoxControl = hm.theHosControl.theAllComboBoxControl; 
        setTableMaimDetail(vMaim);
        setLanguage();        
     }
    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc=" Generated Code ">//GEN-BEGIN:initComponents
    private void initComponents() {
        java.awt.GridBagConstraints gridBagConstraints;

        defaultFont1 = new com.hospital_os.gui.font.DefaultFont();
        jPanel1 = new javax.swing.JPanel();
        jPanel2 = new javax.swing.JPanel();
        jScrollPane3 = new javax.swing.JScrollPane();
        jTableMaim = new javax.swing.JTable();
        jPanel3 = new javax.swing.JPanel();
        jButtonReset1 = new javax.swing.JButton();
        jButtonDelete = new javax.swing.JButton();
        jButtonSave = new javax.swing.JButton();

        setLayout(new java.awt.BorderLayout());

        setMaximumSize(new java.awt.Dimension(300, 83));
        setMinimumSize(new java.awt.Dimension(300, 83));
        setPreferredSize(new java.awt.Dimension(300, 83));
        jPanel1.setLayout(new java.awt.GridBagLayout());

        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder("\u0e04\u0e27\u0e32\u0e21\u0e1e\u0e34\u0e01\u0e32\u0e23"));
        jPanel2.setLayout(new java.awt.BorderLayout());

        jTableMaim.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "Title 1", "Title 2", "Title 3", "Title 4"
            }
        ));
        jTableMaim.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseReleased(java.awt.event.MouseEvent evt) {
                jTableMaimMouseReleased(evt);
            }
        });

        jScrollPane3.setViewportView(jTableMaim);

        jPanel2.add(jScrollPane3, java.awt.BorderLayout.CENTER);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanel1.add(jPanel2, gridBagConstraints);

        jPanel3.setLayout(new java.awt.GridBagLayout());

        jPanel3.setPreferredSize(new java.awt.Dimension(10, 30));
        jButtonReset1.setIcon(new javax.swing.ImageIcon(getClass().getResource("/com/hosv3/gui/images/plus16.gif")));
        jButtonReset1.setMargin(new java.awt.Insets(0, 0, 0, 0));
        jButtonReset1.setMaximumSize(new java.awt.Dimension(26, 26));
        jButtonReset1.setMinimumSize(new java.awt.Dimension(26, 26));
        jButtonReset1.setPreferredSize(new java.awt.Dimension(26, 26));
        jButtonReset1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonReset1ActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.EAST;
        jPanel3.add(jButtonReset1, gridBagConstraints);

        jButtonDelete.setIcon(new javax.swing.ImageIcon(getClass().getResource("/com/hosv3/gui/images/minus16.gif")));
        jButtonDelete.setMargin(new java.awt.Insets(0, 0, 0, 0));
        jButtonDelete.setMaximumSize(new java.awt.Dimension(26, 26));
        jButtonDelete.setMinimumSize(new java.awt.Dimension(26, 26));
        jButtonDelete.setPreferredSize(new java.awt.Dimension(26, 26));
        jButtonDelete.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonDeleteActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(0, 1, 0, 0);
        jPanel3.add(jButtonDelete, gridBagConstraints);

        jButtonSave.setFont(defaultFont1);
        jButtonSave.setIcon(new javax.swing.ImageIcon(getClass().getResource("/com/hospital_os/images/Save16.gif")));
        jButtonSave.setText("Save");
        jButtonSave.setMargin(new java.awt.Insets(2, 4, 2, 4));
        jButtonSave.setMaximumSize(new java.awt.Dimension(100, 26));
        jButtonSave.setMinimumSize(new java.awt.Dimension(60, 26));
        jButtonSave.setPreferredSize(new java.awt.Dimension(80, 26));
        jButtonSave.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonSaveActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 2;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.VERTICAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.EAST;
        gridBagConstraints.weightx = 1.0;
        jPanel3.add(jButtonSave, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(11, 11, 5, 11);
        jPanel1.add(jPanel3, gridBagConstraints);

        add(jPanel1, java.awt.BorderLayout.CENTER);

    }// </editor-fold>//GEN-END:initComponents

    private void jTableMaimMouseReleased(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jTableMaimMouseReleased
// TODO add your handling code here:
        clickDate(jTableMaim.getSelectedRow());
    }//GEN-LAST:event_jTableMaimMouseReleased

    private void jButtonDeleteActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonDeleteActionPerformed
// TODO add your handling code here:
        deleteMaim();
    }//GEN-LAST:event_jButtonDeleteActionPerformed

    private void jButtonSaveActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonSaveActionPerformed
// TODO add your handling code here:
        saveMaim();
    }//GEN-LAST:event_jButtonSaveActionPerformed

    private void jButtonReset1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonReset1ActionPerformed
// TODO add your handling code here:
        insertMaim();
    }//GEN-LAST:event_jButtonReset1ActionPerformed
    
    
    /**
     * ค้นหารายการความพิการ
     * @param  
     * @return 
     * @author Jao
     * @date 04-03-2549
     */
    private void clickDate(int row)
    {   
        if(row != -1)
        {
            dc = (DateComboBox)this.jTableMaim.getValueAt(row,3);            
        }
    }
    
    /**
     * ค้นหารายการความพิการ
     * @param  
     * @return 
     * @author Jao
     * @date 04-03-2549
     */
    private void searchMaim()
    {
        if(this.theFamily != null)
        {
            vMaim = theHM.theHosControl.theUncontagiousControl.listMaim(theFamily.getObjectId());
        }
        setTableMaimDetail(vMaim);
    }
    
    /**
     * เพิ่มรายการความพิการ
     * @param  
     * @return 
     * @author jao
     * @date 04-03-2549
     */
    private void insertMaim()
    {
        if(this.theFamily == null)
        {
            theUS.setStatus(GutilPCU.getTextBundle("WarningNotHaveFamily"),2);
            return;
        }
        if(vMaim == null) vMaim = new Vector();
        addMiamHistory(); 
        vMaim.add(new Maim());
        setTableMaimDetail(vMaim);
    }
    
    
    /**
     * เซต object จาก HospitalOS
     * @param  
     * @return 
     * @author Jao
     * @date 06-03-2549
     */
    public void getObject(PCUObject pcuobject)
    {
        setTableMaimDetail(null);
        if(pcuobject != null)
        {
            theFamily = null;
            theEmployee = pcuobject.getEmployee();
            theVisit = pcuobject.getVisit();
            thePatient = pcuobject.getPatient();                  
        }
        
    }
    
    
    
    /**
     * เซต JFrame
     * @param  
     * @return 
     * @author Jao
     * @date 01-03-2549
     */
    public void setJFrame(JFrame frame)
    {
        this.theJFrame = frame;
    }
    /**
     * เซต JFrame
     * @param  
     * @return 
     * @author neung
     * @date 23-03-2549
     */
    public void setUpdateStatus(UpdateStatus us)
    {
        theUS = us;
    }
     /**
     * เซตประชากร
     * @param  
     * @return 
     * @author Jao
     * @date 04-03-2549
     */    
    public void setFamily(Family family)
    {
        thePatient = null;
        theVisit = null;
        theFamily = family;
        searchMaim();
    }    
    
    /**
     * เลือก JFrame
     * @param  
     * @return 
     * @author Jao
     * @date 04-03-2549
     */
    
    public JFrame getJFrame()
    {
        return this.theJFrame;
    }
     private void setLanguage()
    {
    GutilPCU.setGuiLang(jButtonSave);
    GutilPCU.setGuiLang(jPanel1);
    }
    /**
     * addข้อมูล ความพิการ
     * @param  
     * @return 
     * @author jao
     * @date 04-03-2549
     */
    private void addMiamHistory()
    {        
        for(int i=0, size=this.vMaim.size(); i< size; i++)
        {
            Maim mm = (Maim)this.vMaim.get(i);
            
            JComboBox jComboMaim = (JComboBox)this.jTableMaim.getValueAt(i,1);
            mm.maim_id = Gutil.getGuiData(jComboMaim);
            mm.description = Gutil.CheckReservedWords(((String)jTableMaim.getValueAt(i,2))); 
            DateComboBox dc = (DateComboBox)jTableMaim.getValueAt(i, 3);
            mm.survey_date = dc.getText();
            try{
                JCheckBox chb = (JCheckBox)jTableMaim.getValueAt(i, 4);
                if(chb.isSelected())
                    mm.maim_treat = "1";
                else
                    mm.maim_treat = "0";
            }
            catch(Exception e){
                Constant.println(e.getMessage());
                Boolean chb = (Boolean)jTableMaim.getValueAt(i, 4);
                if(chb.booleanValue())
                    mm.maim_treat = "1";
                else
                    mm.maim_treat = "0";
            }
            try{
                JCheckBox cb = (JCheckBox)jTableMaim.getValueAt(i, 5);
                if(cb.isSelected())
                    mm.maim_registry = "1";
                else
                    mm.maim_registry = "0";
            }
            catch(Exception e){
                Constant.println(e.getMessage());
                Boolean chb = (Boolean)jTableMaim.getValueAt(i, 5);
                if(chb.booleanValue())
                    mm.maim_registry = "1";
                else
                    mm.maim_registry = "0";
            }
            if(mm.getObjectId() == null || "".equals(mm.getObjectId()))
            {
                mm.staff_record = theEmployee.getObjectId();
                mm.record_date_time = DateTime.getTextCurrentDateTime(theHM.theHosControl.theConnectionInf);
            }
            else
             {    
                 Maim mmCurrent = (Maim)this.vMaim.get(i);
                 Maim mmBefor = this.theHM.theHosControl.theUncontagiousControl.readMaimByPk(mmCurrent.getObjectId());
                 if(mmBefor != null)
                 {
                     if(!mmBefor.maim_id.equalsIgnoreCase(mmCurrent.maim_id) 
                     || !mmBefor.maim_registry.equalsIgnoreCase(mmCurrent.maim_registry) 
                     || !mmBefor.survey_date.equalsIgnoreCase(mmCurrent.survey_date) 
                     || !mmBefor.maim_treat.equalsIgnoreCase(mmCurrent.maim_treat))
                    {
                        mmCurrent.modify_date_time = DateTime.getTextCurrentDateTime(this.theHM.theHosControl.theConnectionInf);
                        mmCurrent.staff_modify = this.theEmployee.getObjectId();
                    }
                 }

             }
            if(mm.staff_cancel == null)
             {
                 mm.staff_cancel = "";
                 mm.cancel_date_time = "";
             }
             if(mm.staff_modify == null)
             {
                 mm.staff_modify = "";
                 mm.modify_date_time = "";
             }
             mm.family_id = theFamily.getObjectId();             
             mm.patient_id = "";
             mm.visit_id = "";
             if(thePatient!=null)        
                 mm.patient_id = this.thePatient.getObjectId();
             if(this.pcuobject.getVisit()!=null)        
                 mm.visit_id = pcuobject.getVisit().getObjectId();
//             if(mm.patient_id.equals(""))
//             {
//                 if(!theFamily.patient_id.equals(""))
//                     mm.patient_id = theFamily.patient_id;
//             }
             mm.cancel_date_time = "";
             mm.staff_cancel = "";
             mm.active = "1";
        }
    }
    
    /**
     * เซตตาราง ความพิการ
     * @param  
     * @return 
     * @author jao
     * @date 04-03-2549
     */
    private void setTableMaimDetail(Vector Vmm)
    {
        String[] col = {GutilPCU.getTextBundle("TableChronic_Col1"),
                        GutilPCU.getTextBundle("MaimType"),
                        GutilPCU.getTextBundle("Maim_Description"),
                        GutilPCU.getTextBundle("SurveyDate"),
                        GutilPCU.getTextBundle("MaimTreat"),
                        GutilPCU.getTextBundle("Registry"),};
                    
        Maim maimTemp = new Maim();        
        
        TableModel tm;            
        if(Vmm != null)
        {   
            tm = new TableModel(col,Vmm.size());  
            tm.setEditingCol(1,2,3,4,5); 
            for(int i=0, size=Vmm.size(); i<size; i++)
            {  
                maimTemp = (Maim)Vmm.get(i);                
                JComboBox jComboMaim = new JComboBox();
                ComboboxModel.initComboBox(jComboMaim,this.theAllComboBoxControl.listMaimType());
                Gutil.setGuiData(jComboMaim,maimTemp.maim_id); 
                tm.setValueAt(String.valueOf(i+1), i, 0);
                tm.setValueAt(jComboMaim,i,1);                 
                tm.setValueAt(maimTemp.description,i,2);
                dc = new DateComboBox();
                //dc.setJFrame(this.getJFrame());
                //dc.setJTable(jTableMaim);
//                dc.setWarningFuture(true);
//                dc.setConnection(this.theHM.theHosControl.theConnectionInf);
//                dc.setTable(jTableMaim);
//                dc.setParentComponent(this.getJFrame());
                dc.setEditable(true);                
                if(!"".equals(maimTemp.survey_date))
                {
                    dc.setText(DateUtil.convertFieldDate(maimTemp.survey_date));
                }
                else
                {
                    dc.setText("");
                }
                tm.setValueAt(dc,i,3);

                if("1".equals(maimTemp.maim_treat))
                    tm.setValueAt(Boolean.TRUE, i, 4);
                else
                    tm.setValueAt(Boolean.FALSE, i, 4);
                
                if("1".equals(maimTemp.maim_registry))
                    tm.setValueAt(Boolean.TRUE, i, 5);
                else
                    tm.setValueAt(Boolean.FALSE, i, 5);
                
                
            }
        }
        else
        {   
            tm= new TableModel(col,0);
        }         
        maimTemp = null;
        this.jTableMaim.setModel(tm);  
        
        /***SetTableDefault***/
        jTableMaim.setRowHeight(24);
        jTableMaim.getColumnModel().getColumn(0).setPreferredWidth(2);  
        jTableMaim.getColumnModel().getColumn(1).setPreferredWidth(65);
        jTableMaim.getColumnModel().getColumn(2).setPreferredWidth(75);
        jTableMaim.getColumnModel().getColumn(3).setPreferredWidth(55);        
        jTableMaim.getColumnModel().getColumn(4).setPreferredWidth(3);
        jTableMaim.getColumnModel().getColumn(5).setPreferredWidth(30);
        jTableMaim.getColumnModel().getColumn(0).setCellRenderer(ColumnTableRenderer.getRendererCenter());
        jTableMaim.getColumnModel().getColumn(1).setCellRenderer(new CellRendererComboBox());
        jTableMaim.getColumnModel().getColumn(1).setCellEditor(new ComBoBoxEditor(new JComboBox()));
        jTableMaim.getColumnModel().getColumn(3).setCellRenderer(new CellRendererComboBox());
        jTableMaim.getColumnModel().getColumn(3).setCellEditor(new ComBoBoxEditor(new DateComboBox()));        
        jTableMaim.getColumnModel().getColumn(4).setCellRenderer(new CellRendererCheckBox());
        jTableMaim.getColumnModel().getColumn(4).setCellEditor(new CheckBoxEditor(new JCheckBox()));
        jTableMaim.getColumnModel().getColumn(5).setCellRenderer(new CellRendererCheckBox());
        jTableMaim.getColumnModel().getColumn(5).setCellEditor(new CheckBoxEditor(new JCheckBox()));
    }
    
    /**
     * บันทึกรายการความพิการ
     * @param  
     * @return 
     * @author Jao
     * @date 04-03-2549
     */
    private void saveMaim()
    {
        if(this.theFamily == null)
        {
            theUS.setStatus(GutilPCU.getTextBundle("WarningNotHaveFamily"),2);
            return;
        }
        if(this.vMaim.size() == 0)
        {
            theUS.setStatus(GutilPCU.getTextBundle("WarningNotHave"),2);
            return;
        }
        addMiamHistory();
        if(checkDateSurvey() == false)
        {
            return;
        }
        theHM.theHosControl.theUncontagiousControl.setUpdateStatus(theUS);
        theHM.theHosControl.theUncontagiousControl.saveMaim(vMaim);
        setTableMaimDetail(vMaim);
    }
    
    /**
     * ลบรายการความพิการ
     * @param  
     * @return 
     * @author Jao
     * @date 04-03-2549
     */
    private void deleteMaim()
    {
        int[] select = jTableMaim.getSelectedRows();
        if(select.length == 0)
        {
            theUS.setStatus(GutilPCU.getTextBundle("WarningNotSelect"), 2);
            return;
        }
        if(!theUS.confirmBox(GutilPCU.getTextBundle("DeleteMaim"),UpdateStatus.WARNING))
            return;
        {
            updateDeleteMaim();
            theHM.theHosControl.theUncontagiousControl.delectMaim(this.vMaim, select);
            setTableMaimDetail(this.vMaim);
        }
    }
    /**
     * ทำการอับเดตข้อมูลเมื่อต้องการลบข้อมูล
     * @param  
     * @return 
     * @author Jao
     * @date 04-03-2549
     */
    private void updateDeleteMaim()
    {
        int[] select = jTableMaim.getSelectedRows();
        if(select.length == 0)
        {
            theUS.setStatus(GutilPCU.getTextBundle("WarningNotSelect"), 2);
            return;
        }
        for(int i=select.length-1;i>=0;i--)
        {
            Maim mm = (Maim)vMaim.get(select[i]);
            mm.staff_cancel = this.theEmployee.getObjectId();
            mm.cancel_date_time = DateTime.getTextCurrentDateTime(theHM.theHosControl.theConnectionInf);
            mm.active = "0";
        }
    }
    /**
     * ตรวจสอบวันที่สำรวจว่าครบหรือไม่
     * @param  
     * @return boolean true = มีการใส่วันที่ครบ  false = ใส่วันที่สำรวจไม่ครบ
     * @author kingland
     * @date 1/06/2549
     */
    private boolean checkDateSurvey()
    {        
        boolean result = true;
        for(int i=0;vMaim!=null && i< vMaim.size(); i++)
        {
            Maim us = (Maim)vMaim.get(i);
            if("".equalsIgnoreCase(us.survey_date) || us.survey_date == null)
            {
                result = false;
                theUS.setStatus(GutilPCU.getTextBundle("WarningNotHaveSurVeyDate"), 2);
                break;
            }
        }
        return result;
    }
    /**
     * เคลียร์ GUI หน้าจอความพิการทั้งหมด
     * @param  
     * @return 
     * @author Jao
     * @date 06-03-2549
     */
    public void clearGUIUncontagiousAll()
    {
        setTableMaimDetail(null);
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private com.hospital_os.gui.font.DefaultFont defaultFont1;
    private javax.swing.JButton jButtonDelete;
    private javax.swing.JButton jButtonReset1;
    private javax.swing.JButton jButtonSave;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JTable jTableMaim;
    // End of variables declaration//GEN-END:variables
    
}
